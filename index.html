<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Forestry Scout</title>
    
    <!-- OpenLayers 4.6.5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/openlayers@4.6.5/dist/ol.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #eee; overflow: hidden; }
        
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; }

        /* ヘッダー情報 */
        .info-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); padding: 10px 15px;
            padding-top: env(safe-area-inset-top, 10px);
            z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; backdrop-filter: blur(5px);
        }
        .app-title { font-weight: bold; font-size: 16px; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .layer-status { font-size: 12px; color: #666; }

        /* ボトムナビゲーション */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255,255,255,0.95);
            display: flex; justify-content: space-evenly; /* 均等配置 */
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 20; 
            backdrop-filter: blur(5px);
            padding-bottom: env(safe-area-inset-bottom, 0);
            box-sizing: border-box;
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: none; background: none; color: #7f8c8d;
            font-size: 10px; gap: 4px; cursor: pointer; width: 50px;
            -webkit-tap-highlight-color: transparent;
            padding: 0;
        }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; transition: color 0.2s; }
        .nav-btn.active { color: #3498db; }
        .nav-btn.active i { color: #3498db; }

        /* 中央のメインボタン（スキャン） */
        .scan-btn-wrapper {
            position: relative; top: -20px; /* 少し上に */
            height: 0; display: flex; align-items: center; justify-content: center;
            width: 60px;
        }
        .scan-btn {
            width: 56px; height: 56px; border-radius: 50%;
            background: #27ae60; color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; border: 4px solid #f5f5f5;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .scan-btn:active { transform: scale(0.95); background: #219150; }

        /* ファイル入力 (非表示) */
        #file-input { display: none; }

        /* カメラモーダル */
        #scan-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; flex-direction: column;
        }
        #scan-video { width: 100%; flex: 1; object-fit: cover; }
        #scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 50px solid rgba(0,0,0,0.5); box-sizing: border-box;
            pointer-events: none;
        }
        .scan-msg {
            position: absolute; top: 10%; left: 0; width: 100%;
            text-align: center; color: white; font-weight: bold; text-shadow: 0 1px 3px #000;
            pointer-events: none;
        }
        .close-scan {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 10px 30px; background: rgba(255,255,255,0.2); border: 2px solid white;
            color: white; border-radius: 30px; font-weight: bold; font-size: 16px;
            cursor: pointer; z-index: 2001;
        }

        /* 属性表示ポップアップ */
        #feature-info {
            position: fixed; bottom: -60%; left: 0; width: 100%; height: 50%;
            background: white; z-index: 100;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; flex-direction: column;
        }
        #feature-info.open { bottom: 0; }
        .info-header {
            padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; border-top-left-radius: 20px; border-top-right-radius: 20px;
            color: #2c3e50;
        }
        .info-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px 5px; border-bottom: 1px solid #eee; text-align: left; }
        th { color: #7f8c8d; width: 35%; font-weight: normal; font-size: 12px; }
        td { color: #2c3e50; font-weight: 500; }

        /* 読み込み中表示 */
        #loading { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.7); color:white; padding:15px; border-radius:5px; z-index:9999; }
    </style>
</head>
<body>

<div class="info-bar">
    <div class="app-title"><i class="fas fa-tree"></i> Forestry Scout</div>
    <div class="layer-status" id="layer-count">データなし</div>
</div>

<div id="map"></div>

<!-- ボトムナビゲーション (4ボタン構成) -->
<div class="bottom-nav">
    <button class="nav-btn" onclick="document.getElementById('file-input').click()" title="ファイル読込">
        <i class="fas fa-folder-open"></i>
        <span>ファイル</span>
    </button>
    
    <button class="nav-btn" onclick="toggleMapType()" title="地図切替">
        <i class="fas fa-layer-group"></i>
        <span>地図</span>
    </button>
    
    <div class="scan-btn-wrapper">
        <button class="scan-btn" onclick="startScan()" title="QR読込">
            <i class="fas fa-qrcode"></i>
        </button>
    </div>

    <button class="nav-btn" id="gps-btn" onclick="toggleGPS()" title="現在地">
        <i class="fas fa-location-arrow"></i>
        <span>現在地</span>
    </button>
</div>

<!-- ファイル入力 (隠し要素) -->
<input type="file" id="file-input" accept=".zip,.geojson,.json,.kml">

<!-- QRスキャン画面 -->
<div id="scan-modal">
    <div class="scan-msg">QRコードを枠内に入れてください</div>
    <video id="scan-video" playsinline></video>
    <canvas id="scan-canvas" style="display:none;"></canvas>
    <div id="scan-overlay"></div>
    <button class="close-scan" onclick="stopScan()">閉じる</button>
</div>

<!-- 属性情報パネル -->
<div id="feature-info">
    <div class="info-header">
        <span><i class="fas fa-info-circle"></i> 地物情報</span>
        <i class="fas fa-times" onclick="closeInfo()" style="padding:5px 10px; cursor:pointer; font-size:18px; color:#95a5a6;"></i>
    </div>
    <div class="info-content" id="info-table"></div>
</div>

<div id="loading"><i class="fas fa-spinner fa-spin"></i> 処理中...</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/openlayers@4.6.5/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<!-- shpjs: Zip読み込み用 -->
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

<script>
    // --- 初期化 ---
    const baseLayers = {
        std: new ol.layer.Tile({ source: new ol.source.XYZ({ url: "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", attributions: "地理院", crossOrigin: 'anonymous' }), visible: true }),
        photo: new ol.layer.Tile({ source: new ol.source.XYZ({ url: "https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg", attributions: "地理院", crossOrigin: 'anonymous' }), visible: false })
    };

    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
            fill: new ol.style.Fill({ color: 'rgba(231, 76, 60, 0.4)' }),
            stroke: new ol.style.Stroke({ color: '#c0392b', width: 2 }),
            image: new ol.style.Circle({ radius: 6, fill: new ol.style.Fill({color: '#e74c3c'}), stroke: new ol.style.Stroke({color:'#fff', width:2}) })
        })
    });

    const gpsSource = new ol.source.Vector();
    const gpsLayer = new ol.layer.Vector({
        source: gpsSource,
        zIndex: 999,
        style: new ol.style.Style({
            image: new ol.style.Circle({ radius: 8, fill: new ol.style.Fill({color: '#3498db'}), stroke: new ol.style.Stroke({color: '#fff', width: 3}) })
        })
    });

    const map = new ol.Map({
        target: 'map',
        controls: ol.control.defaults({ attribution: false, zoom: false }),
        layers: [ baseLayers.std, baseLayers.photo, vectorLayer, gpsLayer ],
        view: new ol.View({ center: ol.proj.fromLonLat([138, 36]), zoom: 6 })
    });

    function toggleMapType() {
        const isStd = baseLayers.std.getVisible();
        baseLayers.std.setVisible(!isStd);
        baseLayers.photo.setVisible(isStd);
    }

    // --- ファイル読み込み処理 ---
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        document.getElementById('loading').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                if (file.name.match(/\.zip$/i)) {
                    // shpjsでZIP解析
                    shp(ev.target.result).then(geojson => {
                        addGeoJSONFeatures(geojson);
                        document.getElementById('loading').style.display = 'none';
                    }).catch(err => {
                        throw new Error("ZIP解析失敗: " + err);
                    });
                } else if (file.name.match(/\.json$|\.geojson$/i)) {
                    const json = JSON.parse(ev.target.result);
                    addGeoJSONFeatures(json);
                    document.getElementById('loading').style.display = 'none';
                } else if (file.name.match(/\.kml$/i)) {
                    // KML解析
                    const features = new ol.format.KML({extractStyles:false}).readFeatures(ev.target.result, {featureProjection:'EPSG:3857'});
                    if (features.length > 0) {
                        vectorSource.addFeatures(features);
                        map.getView().fit(vectorSource.getExtent(), { padding: [50, 50, 50, 50], duration: 1000 });
                        updateStatus(features.length);
                    }
                    document.getElementById('loading').style.display = 'none';
                } else {
                    alert("未対応のファイル形式です");
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (err) {
                alert("読み込みエラー: " + err.message);
                document.getElementById('loading').style.display = 'none';
            }
        };

        if (file.name.match(/\.zip$/i)) {
            reader.readAsArrayBuffer(file);
        } else {
            reader.readAsText(file);
        }
        
        // ファイル入力をリセット（同じファイルを再度選べるように）
        this.value = '';
    });

    function addGeoJSONFeatures(json) {
        const features = new ol.format.GeoJSON().readFeatures(json, { featureProjection: 'EPSG:3857' });
        if (features.length > 0) {
            vectorSource.addFeatures(features);
            map.getView().fit(vectorSource.getExtent(), { padding: [50, 50, 50, 50], duration: 1000 });
            updateStatus(features.length);
            alert(`${features.length}件のデータを読み込みました`);
        } else {
            alert("有効な地物がありません");
        }
    }

    function updateStatus(count) {
        document.getElementById('layer-count').textContent = `地物数: ${vectorSource.getFeatures().length}`;
    }

    // --- QRスキャンロジック ---
    const video = document.getElementById('scan-video');
    const canvas = document.getElementById('scan-canvas');
    const ctx = canvas.getContext('2d');
    let animationFrameId = null;
    let qrBuffer = { total: 0, parts: [] };

    function startScan() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            alert("カメラにはHTTPSが必要です"); return;
        }
        document.getElementById('scan-modal').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
            video.srcObject = stream; video.setAttribute("playsinline", true); video.play(); requestAnimationFrame(tick);
        }).catch(err => { alert("カメラ起動失敗: " + err); stopScan(); });
    }

    function stopScan() {
        document.getElementById('scan-modal').style.display = 'none';
        if(video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); video.srcObject = null; }
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight; canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
            if (code) { stopScan(); handleScannedData(code.data); return; }
        }
        animationFrameId = requestAnimationFrame(tick);
    }

    function handleScannedData(data) {
        const match = data.match(/^FGS:(\d+)\/(\d+):(.*)$/);
        if (match) {
            const index = parseInt(match[1]); const total = parseInt(match[2]); const chunk = match[3];
            if (qrBuffer.total === 0) { qrBuffer.total = total; qrBuffer.parts = new Array(total).fill(null); alert(`分割データ(${total}枚)を検知。1枚目を読込完了。`); } 
            else if (qrBuffer.total !== total) { alert("データ不一致。リセットします。"); qrBuffer = { total: 0, parts: [] }; return; }

            if (qrBuffer.parts[index - 1] === null) {
                qrBuffer.parts[index - 1] = chunk;
                const receivedCount = qrBuffer.parts.filter(p => p !== null).length;
                if (receivedCount === total) { processGeoJSON(qrBuffer.parts.join("")); qrBuffer = { total: 0, parts: [] }; } 
                else { alert(`${index}/${total} 読込完了。残り${total - receivedCount}枚。`); startScan(); }
            } else { alert(`このQR(${index}/${total})は読込済みです。`); startScan(); }
            return;
        }
        processGeoJSON(data);
    }

    function processGeoJSON(data) {
        document.getElementById('loading').style.display = 'block';
        setTimeout(() => {
            try {
                const decompressed = LZString.decompressFromBase64(data);
                if (!decompressed) throw new Error("解凍失敗");
                addGeoJSONFeatures(JSON.parse(decompressed));
            } catch (e) { alert("読込エラー: " + e.message); console.error(e); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }, 100);
    }

    // --- GPSロジック ---
    let watchId = null;
    function toggleGPS() {
        const btn = document.getElementById('gps-btn');
        if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; btn.classList.remove('active'); gpsSource.clear(); } 
        else {
            if (!navigator.geolocation) { alert("GPS非対応"); return; }
            btn.classList.add('active');
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const xy = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                    gpsSource.clear(); gpsSource.addFeature(new ol.Feature(new ol.geom.Point(xy)));
                },
                (err) => { alert("GPSエラー: " + err.message); toggleGPS(); }, { enableHighAccuracy: true }
            );
            navigator.geolocation.getCurrentPosition(pos => {
                const xy = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                map.getView().animate({ center: xy, zoom: 16, duration: 1000 });
            });
        }
    }

    // --- 地物クリック ---
    map.on('click', function(e) {
        const pixel = map.getEventPixel(e.originalEvent);
        const feature = map.forEachFeatureAtPixel(pixel, f => f, { hitTolerance: 10 });
        if (feature && feature !== gpsSource.getFeatures()[0]) showFeatureInfo(feature); else closeInfo();
    });

    function showFeatureInfo(feature) {
        const props = feature.getProperties();
        let html = '<table>';
        Object.keys(props).forEach(k => { if (k !== 'geometry' && k !== 'style') html += `<tr><th>${k}</th><td>${props[k]}</td></tr>`; });
        html += '</table>';
        document.getElementById('info-table').innerHTML = html; document.getElementById('feature-info').classList.add('open');
    }
    function closeInfo() { document.getElementById('feature-info').classList.remove('open'); }
</script>
</body>
</html>
